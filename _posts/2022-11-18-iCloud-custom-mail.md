---
layout: post
title: 在 iCloud+ 中配置自定义域名邮箱
subtitle: 自讨苦吃
author: Cain Minami
categories: 技术
tags: 班门弄斧
sidebar: [article-menu]
---

2021年，Apple 开始正式向所有付费购买了 iCloud 存储空间的用户[^1]（iCloud+）提供自定义域名邮箱的托管服务。看在我开了 200G 的空间的份上，正好最近在折腾域名，就打算把这个送的功能利用起来，反正不用白不用（。


## 部署
在设置界面，Apple 集成了 Cloudflare（CF）的域名注册服务，如果你的域名是托管在 CF 或 DNS 服务商为 CF 的话（包括在这个页面直接购买域名），苹果提供简单快捷的配置流程。当 iCloud 服务器确认你的域名属于 CF 后，点击允许后即完成了相关内容的配置。不过如果你想使用子域名搭建邮箱，如 `mail.example.com`，则需要手动配置相关内容。


## 问题
当你需要手动配置时，受限于不同服务商所支持的格式和内容的差异，有部分细节是需要调整的。除了页面上提醒你的尝试去掉域名结尾的 `.` 和配置内容中的 `"` 以外，下面这些是你可能还需要注意的地方。

### SPF
iCloud 邮箱的 SPF 设置有几个容易出问题的地方。第一个是 iCloud 服务器检查的是 TXT 项中的内容，而不是 SPF，所以即使你的 DNS 服务商提供了 SPF 选项，也应该在 TXT 中输入相关内容。另外，当去掉 `"` 后仍无法正确配置时，可以考虑在开头结尾各增加一个引号[^2]，就像这样：

```
""v=spf1 include:icloud.com ~all""
```

### 子域名
即使你用子域名作为邮箱的时候，iCloud 还是会认为这是一个独立的域名，因此在给出的配置文件中，所有的 host 字段都是 `@`，记得把它们改成你的子域名。

## 体验
### iCloud
配置好自定义域名邮箱以后，这个域名最多可以给包括你在内的六个人使用，与 iCloud 的家庭共享中支持的人数一致，不过这里可以给家庭以外的人共享你的域名邮箱。同一个域名下每个人最多登记3个不同的地址，每个共享群组最多登记5个不同的域名。这个支持的邮箱地址数量可以说是非常「克制」了，小而美也不过如此。假如你对此有更大的需求，可以考虑通过注册多个子域名来实现最多15个可发信的邮箱。

既然是托管在 iCloud 服务器上的，这个邮箱的体验与 iCloud 邮件服务一致。它能力一般，水平有限，而且可能还不支持第三方应用登录。第三方应该是只能登录 iCloud 的主邮件帐户，也就意味着发信还要回到网页版或是自带的邮件 app 中了，不过所有的邮件都在里面。鉴于它没什么好的地方，在这里也不过多赘述。

### Cloudflare
由于 CF 也提供免费的域名邮箱转发服务，这两者肯定会被拿来做比较的。CF 服务中登记的邮箱地址只能用于接收邮件，无法发送邮件。但是与提供有限数量的 iCloud 服务相比，CF 提供未登记邮箱地址的邮件转发。既然 CF 的服务只能提供邮件的接收和转发，开启这个功能以后，在个人使用的一般情况下，已经没有多大必要去登记邮箱地址了，这样也就获得了无上限的自定义邮箱地址。这时候登记地址的主要意义大概是 drop 掉发往特定地址的邮件了吧。

CF 的邮件转发还提供了简单的邮件数据统计。发往未登记地址的邮件可以被成功转发，CF 提供的邮件分析统计也可以正确统计。

### 我的选择
最终考虑到体验与应用的平衡，我把 `*@mail.corn.moe` 托管到 iCloud，主要用于邮件的发送与回复；而 `*@corn.moe` 则托管到 Cloudflare，用于接收邮件。

### 温馨提示
在 CF 中设置邮件相关配置后会提示已锁定 MX 记录的修改权限，修改权限可以解锁，并且不会影响 CF 邮件转发的正常工作。

![Cloudflare 邮件 DNS 设置页面](/assets/images/posts/221117_iCloud_CloudflareMX.png)


## Apple WTF
最后插播一点苹果的 mind fxxk。在 iCloud 的 [QA 界面](https://support.apple.com/zh-tw/HT212514) 中，苹果要求托管在 iCloud 的自定义域名邮箱不能作为 Apple ID 的登录凭证，必须更换其他邮箱。但在这其中，还有这么一句话：

> 如果刪除該 Apple ID（而没有在删除前变更邮箱[^3]），你仍將無法（将这个邮箱）加入個人化電子郵件地址。

所以你们注销账号之后账号数据是不会删除永久保存的吗？

---
[^1]: 在正式版发布后，国区 Apple ID 取消了该功能，[有人](https://discussionschinese.apple.com/thread/253176687) 致电苹果客户支持并确认了这一变更。此外，无论设备在何处购买，当设备所在位置为中国时，Private relay 亦不可用。
[^2]: 该方法参考了 [这里](https://discussions.apple.com/thread/253706701)，但实际部署过程中 Namesilo 的 DNS 只需去掉头尾的引号即可。
[^3]: 引文中括号内的内容为方便读者理解上下文而添加，下同。